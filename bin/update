#!/bin/sh

# A super generic update script to update my system in one go.

# TODO:
#   * Make gentoo part smarted (use return codes)

. $HOME/lib/shell/colorenv

# repo list
GIT_DOTS="git -C $HOME"
GIT_PRIV="git -C $HOME/lib/private"
GIT_PASS="git -C $HOME/usr/passwords"
GIT_PUBS="git -C $HOME/usr/papers"
GIT_BOOK="git -C $HOME/usr/bookmarks"
GIT_NOTE="git -C $HOME/usr/notes"

# Update system packages
if [ "$DISTRO" = "ubuntu" ]; then
    echo "sudo apt-get update && sudo apt-get upgrade"
    sudo apt-get update && sudo apt-get upgrade

elif [ "$DISTRO" = "void" ]; then
    sudo xbps-install -Su

elif [ "$DISTRO" = "gentoo" ]; then
    echo -e "${Blue}sudo emerge --sync${Rst}"
    sudo emerge --sync
    echo -e "${Blue}sudo emerge -DuvaN --with-bdeps=y @world${Rst}"
    sudo emerge -DuvaN --with-bdeps=y @world
    echo -e "${Blue}sudo emerge --depclean${Rst}"
    sudo emerge --depclean
    echo -e "${Blue}sudo revdep-rebuild${Rst}"
    sudo revdep-rebuild

else
    echo "Don't have update commands for $DISTRO"
fi

# Git updater
git_update() {
    GIT="$@"
    DIR="$3"
    if [ -z "$(git status --porcelain)" ]; then
        echo -e "${Red}Local changes need to be resolved${Rst}"
        $GIT status
    else
        REMOTE_BRANCH=$($GIT for-each-ref --format='%(upstream:short)' \
                        "$( $GIT symbolic-ref -q HEAD )")
        echo -e "${Green}Pulling from ${REMOTE_BRANCH} for repo: ${DIR}${Rst}"
        $GIT pull
    fi
}

# Start ssh-agent so we don't have to type passphrase multiple times
eval `ssh-agent -s`
ssh-add ~/.ssh/id_rsa

# Update my git repositories
git_update $GIT_DOTS
git_update $GIT_PRIV
git_update $GIT_PASS
git_update $GIT_PUBS
git_update $GIT_BOOK
git_update $GIT_NOTE

# Kill ssh-agent
pkill ssh-agent
